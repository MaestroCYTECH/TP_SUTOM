<!DOCTYPE html>
<html lang="fr">

<head>
    <meta charset="utf-8">
    <title>SUTOM Youssef Agoussal</title>
    <link href="css/style.css" rel="stylesheet" />

    <!-- Jquery -->
    <script src="/jquery-3.6.0.js"></script>
</head>

<body>

    <h1 class="title">SUTOM</h1> <br><br>


    <div style="text-align: right">
        Bonjour, <span id="user" style="color: yellow"></span>

        <button onclick="logout()" class="logout">Logout</button>
    </div>

    <br>
    <button onclick="document.location = 'http://localhost:3000/score.html'">CLICK TO SEE SCORE</button>
    <br><br>



    <div id="gameContainer">
        <form id="inputForm">
            <label>Guess the word in <span id="letters_number"></span> letters beginning by <span
                    id="begin_letter"></span></label><br>

            <input style="text-transform: uppercase;" id="response" /><br>
            <input type="submit" value="Submit">
        </form>

        <!--Affichage des mots bien placés :-->
        <span id="progress"></span>
    </div>


</body>

<script>

    // Verfication si l'utilisateur est connecté
    if (localStorage.getItem('user') == null) {
        alert('Please log in first');
        window.location.href = "http://localhost:3000/login.html";
    }
    document.getElementById('user').innerHTML = localStorage.getItem('user');


    function logout() {
        localStorage.removeItem('user');
        localStorage.removeItem('score');
        localStorage.removeItem('average');
        alert('Logged out');
        window.location.href = "http://localhost:3000/login.html";
    }


    // Gestion du jeu de MOTUS
    var word = "";
    var attempts = 0;

    $.get("/word", function (data) {
        word = data.trim().toUpperCase()
        document.getElementById('letters_number').innerHTML = word.length;
        document.getElementById('begin_letter').innerHTML = word[0];


        $("#response").attr("maxlength", word.length)
        $("#response").attr("minlength", word.length)

        $("form").on("submit", function (e) {
            e.preventDefault();
            submit_response()
        });
    });

    function submit_response() {
        response = $("#response").val().toUpperCase()
        if (response.length != word.length) {
            alert("Incorrect word length")
        }

        response_analysis = ""
        var found = true; //Used to know when to end the game

        for (i = 0; i < word.length; i++) {
            letter = response[i]

            if (letter == word[i]) {
                response_analysis += getSpan(letter, 'palegreen')
            }
            else if (word.split('').includes(letter)) {
                found = false;
                response_analysis += getSpan(letter, 'orange')
            }
            else {
                found = false;
                response_analysis += getSpan(letter, 'none')
            }
        }
        $("#progress").append(response_analysis + "<br />")
        $("#response").val('')
        $("#response").focus()
        attempts++;

        // Si l'utilisateur a gagné :
        if (found) {
            alert('You have found the word of the day ! Attempts : ' + attempts);


            // Appel de l'API score
            $.ajax({
                url: "http://localhost:3001/win_game",
                type: "POST",
                data: {
                    'user': localStorage.getItem('user'),
                    'attempts': attempts
                },
                success: function (data) {
                    console.log("Score updated");
                }
            })
        }
    }

    function getSpan(letter, color) {
        return `<span style="background-color:${color}">${letter.toUpperCase()}&nbsp</span>`
    }

    $("#response").focus()



</script>

</html>