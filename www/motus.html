<!DOCTYPE html>
<html lang="fr">

<head>
    <meta charset="utf-8">
    <title>SUTOM Youssef Agoussal - Rose Mouille</title>
    <link href="css/style.css" rel="stylesheet" />

    <!-- Jquery -->
    <script src="/jquery-3.6.0.js"></script>
</head>

<body>

    <h1 class="title">SUTOM</h1> <br><br>


    <div style="text-align: right">
        Hello, <span id="user" style="color: yellow"></span>

        <button onclick="window.location.href = 'http://localhost:8081/logout'" class="logout">Logout</button>
    </div>

    <br>
    <button onclick="document.location = 'http://localhost:8080/score'">CLICK TO SEE SCORE</button>
    <br><br>



    <div id="gameContainer">
        <form id="inputForm">
            <label>Guess the word in <span id="letters_number"></span> letters beginning by <span
                    id="begin_letter"></span></label><br>

            <input style="text-transform: uppercase;" id="response" /><br>
            <input type="submit" value="Submit" id="submit">
        </form>

        <!--Affichage des mots bien placés :-->
        <span id="tries_left"></span><br>
        <span id="progress"></span>
    </div>

    <div id="includedContent"></div>
</body>

<script>

    // Verification si l'utilisateur est connecté
    var user_local
    $.ajax({
        url: "http://localhost:8081/get_user",
        type: "GET",
        async: false,
        success: function (data) {
            if (data.user == null) {
                alert('Please log in first');


                window.location.href = "http://localhost:8080/login.html";
            }
            document.getElementById('user').innerHTML = data.user
            user_local = data.user
        }
    });

    // Verification qu'il n'ait pas deja joué
    if (typeof user_local != 'undefined') {
        $.ajax({
            url: "http://localhost:8081/has_played",
            type: "GET",
            success: function (data) {
                if (data.has_played) {
                    document.getElementById('response').setAttribute('disabled', '')
                    document.getElementById('submit').setAttribute('disabled', '')
                    $("#progress").append("<br>YOU ALREADY PLAYED TODAY, PLEASE COME BACK TOMORROW")
                    document.getElementById('progress').style = "color: yellow"
                }
            }
        });
    }

    function readTextFile(file) {
        var rawFile = new XMLHttpRequest();
        rawFile.open("GET", file, false);
        rawFile.onreadystatechange = function () {
            if (rawFile.readyState === 4) {
                if (rawFile.status === 200 || rawFile.status == 0) {
                    var allText = rawFile.responseText;
                    alert(allText);
                }
            }
        }
        rawFile.send(null);
    }


    // Gestion du jeu de MOTUS
    var word = "";
    var attempts = 0;
    var max_attempts = 6;
    var words_list = []

    $.get("/word", function (data) {
        word = data.word.trim().toUpperCase()
        words_list = data.text_array
        document.getElementById('letters_number').innerHTML = word.length;
        document.getElementById('begin_letter').innerHTML = word[0];


        $("#response").attr("maxlength", word.length)
        $("#response").attr("minlength", word.length)

        $("form").on("submit", function (e) {
            e.preventDefault();

            if (words_list.includes($("#response").val())){
                submit_response()
            }
            else{
                alert("Ce mot n'existe pas, merci de rentrer un mot français")
            }
        });
    });

    function submit_response() {
        response = $("#response").val().toUpperCase()
        if (response.length != word.length) {
            alert("Incorrect word length")
            return
        }


        // Dictionary to handle green and orange letters repetitions
        var dicWord = new Map();
        // Building the dictionary
        for (i = 0; i < word.length; i++) {
            s = word[i]
            if (dicWord.has(s)) {
                dicWord.set(s, parseInt(dicWord.get(s)) + 1);
            }
            else {
                dicWord.set(s, 1);
            }
        }

        // List of spans that will be joined to make response_analysis
        var spanList = new Array(word.length);
        response_analysis = ""
        var found = true; //Used to know when to end the game

        // Finding the green letters
        for (i = 0; i < word.length; i++) {
            letter = response[i]
            if (letter == word[i]) {
                spanList[i] = getSpan(letter, 'palegreen');
                dicWord.set(letter, parseInt(dicWord.get(letter)) - 1);
            }
        }

        // adding the orange and gray letters to the list of spans
        for (i = 0; i < word.length; i++) {
            letter = response[i]

            if (letter != word[i]) {
                if (word.split('').includes(letter)) {
                    if (parseInt(dicWord.get(letter)) > 0) {
                        spanList[i] = getSpan(letter, 'orange');
                        dicWord.set(letter, parseInt(dicWord.get(letter)) - 1);

                    }
                    else {
                        spanList[i] = getSpan(letter, 'none');
                    }
                }

                else {
                    spanList[i] = getSpan(letter, 'none');
                }
                found = false;
            }
        }


        response_analysis = spanList.join("");


        $("#progress").append(response_analysis + "<br />")
        $("#response").val('')
        $("#response").focus()
        attempts++;

        document.getElementById('tries_left').innerHTML = 'Remaining attempts : ' + (max_attempts - attempts)

        // Si l'utilisateur a gagné :
        if (found) {
            alert('You have found the word of the day ! Attempts : ' + attempts);

            // Appel de l'API score
            $.ajax({
                url: "http://localhost:8082/win_game",
                type: "POST",
                data: {
                    'user': user_local,
                    'attempts': attempts
                },
                success: function (data) {
                    document.getElementById('submit').setAttribute('disabled', '')
                    document.getElementById('response').setAttribute('disabled', '')//Empeche le joueur de rejouer
                }
            })
        }
        //Si il a pas gagné et qu'il a épuisé tous ses essais, il peut plus rejouer aujourd'hui:
        else {
            if (attempts >= max_attempts) {

                //Met à jour la date de la derniere partie, mais n'augmente pas le score du joueur
                $.ajax({
                    url: "http://localhost:8082/lose_game",
                    type: "POST",
                    data: {
                        'user': user_local
                    },
                    success: function (data) {
                        document.getElementById('submit').setAttribute('disabled', '')
                        document.getElementById('response').setAttribute('disabled', '')
                        $("#progress").append("<br><span style='color: yellow'>GAME OVER</span> : YOU REACHED THE MAXIMUM TRIES ALLOWED, PLEASE COME BACK TOMORROW")
                    }
                })
            }
        }
    }


    function getSpan(letter, color) {
        return `<span style="background-color:${color}">${letter.toUpperCase()}&nbsp</span>`
    }

    $("#response").focus()

    $(function () {
        $("#includedContent").load("footer.html");
    });

</script>

</html>